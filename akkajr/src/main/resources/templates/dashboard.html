<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microservices Communication Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .services-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .service-panel {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 15px;
            border-radius: 5px;
        }

        .service-panel.service1 {
            border-left-color: #3498db;
        }

        .service-panel.service2 {
            border-left-color: #e74c3c;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-top: 10px;
        }

        button:hover {
            background: #5568d3;
        }

        .btn-primary { background: #3498db; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #2ecc71; }
        .btn-success:hover { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }

        .message-list {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .message-item {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #ddd;
            background: #f8f9fa;
            border-radius: 3px;
        }

        .message-item.tell {
            border-left-color: #3498db;
        }

        .message-item.ask {
            border-left-color: #e74c3c;
        }

        .message-item.remote {
            background: #fff3cd;
            border-left-color: #f39c12;
        }

        .message-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .message-content {
            color: #666;
            font-size: 14px;
        }

        .message-meta {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 5px 5px 0;
        }

        .status-alive {
            background: #2ecc71;
            color: white;
        }

        .status-dead {
            background: #e74c3c;
            color: white;
        }

        .communication-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        .service-box {
            flex: 1;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .arrow {
            font-size: 2em;
            color: #667eea;
            margin: 0 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        /* NEW: Logs panel styles */
        .logs-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .log-panel {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-entry.remote {
            color: #f39c12;
        }

        .log-entry.local {
            color: #3498db;
        }

        .log-entry.error {
            color: #e74c3c;
        }

        .log-entry.info {
            color: #2ecc71;
        }

        .log-timestamp {
            color: #888;
            margin-right: 10px;
        }

        /* NEW: Communication diagram */
        .comm-diagram {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .comm-line {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .comm-line.remote {
            border-left-color: #f39c12;
        }

        .comm-line.error {
            border-left-color: #e74c3c;
        }

        .comm-arrow {
            margin: 0 10px;
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê Microservices Communication Dashboard</h1>

        <!-- Service Info -->
        <div class="panel">
            <h2>Service Actuel: <span id="currentServiceName"></span></h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalMessages">0</div>
                    <div class="stat-label">Messages Totaux</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="remoteMessages">0</div>
                    <div class="stat-label">Messages Remote</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="deadLetters">0</div>
                    <div class="stat-label">Dead Letters</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingAsks">0</div>
                    <div class="stat-label">ASK en Attente</div>
                </div>
            </div>
        </div>

        <!-- Communication Flow -->
        <div class="panel">
            <h2>üì° Communication Inter-Microservices</h2>
            <div class="communication-flow">
                <div class="service-box">
                    <h3>Service 1 (Port 8080)</h3>
                    <div id="service1Status" class="status-badge status-alive">üü¢ Online</div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        Messages: <span id="service1MessageCount">0</span>
                    </div>
                </div>
                <div class="arrow">‚áÑ</div>
                <div class="service-box">
                    <h3>Service 2 (Port 8081)</h3>
                    <div id="service2Status" class="status-badge status-alive">üü¢ Online</div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        Messages: <span id="service2MessageCount">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Real-time Communication Logs -->
        <div class="panel">
            <h2>üìã Logs de Communication en Temps R√©el</h2>
            <button onclick="refreshLogs()" class="btn-success">üîÑ Rafra√Æchir Logs</button>
            <button onclick="clearLogs()" class="btn-danger">üóëÔ∏è Effacer</button>
            <div class="logs-container" style="margin-top: 15px;">
                <div>
                    <h3 style="color: #3498db; margin-bottom: 10px;">Service 1 Logs</h3>
                    <div id="service1Logs" class="log-panel">
                        <div class="log-entry info">En attente de logs...</div>
                    </div>
                </div>
                <div>
                    <h3 style="color: #e74c3c; margin-bottom: 10px;">Service 2 Logs</h3>
                    <div id="service2Logs" class="log-panel">
                        <div class="log-entry info">En attente de logs...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Communication Flow Diagram -->
        <div class="panel">
            <h2>üîÑ Flux de Communication R√©cent</h2>
            <button onclick="refreshCommFlow()" class="btn-success">üîÑ Rafra√Æchir</button>
            <div id="commFlowDiagram" class="comm-diagram" style="margin-top: 15px;">
                <p style="text-align: center; color: #999;">Aucune communication r√©cente</p>
            </div>
        </div>

        <!-- Send Message Panel -->
        <div class="panel">
            <h2>üì§ Envoyer un Message</h2>
            <div class="form-group">
                <label>Type de Message</label>
                <select id="messageType">
                    <option value="tell">TELL (Asynchrone)</option>
                    <option value="ask">ASK (Synchrone)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Exp√©diteur (Sender ID)</label>
                <input type="text" id="senderId" placeholder="Ex: agentA" value="agentA">
            </div>
            <div class="form-group">
                <label>Destinataire (Receiver ID)</label>
                <input type="text" id="receiverId" placeholder="Ex: service2:agentB ou agentB">
                <small style="color: #666;">Format: "service2:agentB" pour remote, "agentB" pour local</small>
            </div>
            <div class="form-group">
                <label>Contenu du Message</label>
                <input type="text" id="messageContent" placeholder="Votre message ici...">
            </div>
            <button onclick="sendMessage()" class="btn-primary">üì§ Envoyer Message</button>
            <button onclick="clearForm()" class="btn-danger">üóëÔ∏è Effacer</button>
        </div>

        <!-- Messages History -->
        <div class="panel">
            <h2>üìú Historique des Messages</h2>
            <button onclick="refreshHistory()" class="btn-success">üîÑ Rafra√Æchir</button>
            <button onclick="clearHistory()" class="btn-danger">üóëÔ∏è Effacer</button>
            <div id="historyList" class="message-list"></div>
        </div>

        <!-- Inbox Panel -->
        <div class="services-grid">
            <div class="service-panel service1">
                <h3>üì• Inbox - Service 1</h3>
                <div class="form-group">
                    <label>Agent ID</label>
                    <input type="text" id="inboxAgent1" placeholder="Ex: agentA" value="agentA">
                    <button onclick="viewInbox('service1')" class="btn-primary">Voir Inbox</button>
                </div>
                <div id="inbox1List" class="message-list"></div>
            </div>

            <div class="service-panel service2">
                <h3>üì• Inbox - Service 2</h3>
                <div class="form-group">
                    <label>Agent ID</label>
                    <input type="text" id="inboxAgent2" placeholder="Ex: agentB" value="agentB">
                    <button onclick="viewInbox('service2')" class="btn-primary">Voir Inbox</button>
                </div>
                <div id="inbox2List" class="message-list"></div>
            </div>
        </div>

        <!-- Dead Letters -->
        <div class="panel">
            <h2>üíÄ Dead Letters (Messages Bloqu√©s)</h2>
            <button onclick="refreshDeadLetters()" class="btn-success">üîÑ Rafra√Æchir</button>
            <div id="deadLettersList" class="message-list"></div>
        </div>
    </div>

    <script>
        const SERVICE1_URL = 'http://localhost:8080';
        const SERVICE2_URL = 'http://localhost:8081';
        const CURRENT_SERVICE = '{{serviceName}}' || 'service1';
        const CURRENT_SERVICE_URL = window.location.origin;

        // Affiche le nom du service actuel
        document.getElementById('currentServiceName').textContent = CURRENT_SERVICE;

        // NEW: Refresh logs from both services
        async function refreshLogs() {
            const log1 = document.getElementById('service1Logs');
            const log2 = document.getElementById('service2Logs');
            
            log1.innerHTML = '<div class="log-entry info">Chargement...</div>';
            log2.innerHTML = '<div class="log-entry info">Chargement...</div>';

            try {
                // Fetch logs from both services
                const [logs1, logs2] = await Promise.allSettled([
                    fetch(`${SERVICE1_URL}/api/messages/logs`).then(r => r.ok ? r.json() : null),
                    fetch(`${SERVICE2_URL}/api/messages/logs`).then(r => r.ok ? r.json() : null)
                ]);

                // Display Service 1 logs
                if (logs1.status === 'fulfilled' && logs1.value) {
                    displayLogs(log1, logs1.value, 'service1');
                } else {
                    log1.innerHTML = '<div class="log-entry error">Service 1 non disponible</div>';
                }

                // Display Service 2 logs
                if (logs2.status === 'fulfilled' && logs2.value) {
                    displayLogs(log2, logs2.value, 'service2');
                } else {
                    log2.innerHTML = '<div class="log-entry error">Service 2 non disponible</div>';
                }
            } catch (error) {
                console.error('Erreur logs:', error);
                log1.innerHTML = '<div class="log-entry error">Erreur: ' + error.message + '</div>';
                log2.innerHTML = '<div class="log-entry error">Erreur: ' + error.message + '</div>';
            }
        }

        // NEW: Display logs in log panel
        function displayLogs(container, logsData, serviceName) {
            container.innerHTML = '';
            
            if (!logsData.entries || logsData.entries.length === 0) {
                container.innerHTML = '<div class="log-entry info">Aucun log disponible</div>';
                return;
            }

            // Sort by timestamp (newest first)
            const sortedLogs = logsData.entries.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            sortedLogs.forEach(entry => {
                const logEntry = document.createElement('div');
                const logClass = entry.isRemote ? 'remote' : 'local';
                const timestamp = entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString() : 'N/A';
                
                logEntry.className = `log-entry ${logClass}`;
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span>
                    <strong>${entry.type || 'MSG'}</strong> 
                    ${entry.sender || 'N/A'} ‚Üí ${entry.receiver || 'N/A'}
                    ${entry.isRemote ? 'üåê' : 'üè†'}
                    <br>
                    <span style="color: #aaa; margin-left: 20px;">${entry.content || ''}</span>
                `;
                container.appendChild(logEntry);
            });
        }

        // NEW: Refresh communication flow diagram
        async function refreshCommFlow() {
            const diagram = document.getElementById('commFlowDiagram');
            diagram.innerHTML = '<p style="text-align: center; color: #999;">Chargement...</p>';

            try {
                const [history1, history2] = await Promise.allSettled([
                    fetch(`${SERVICE1_URL}/api/messages/history`).then(r => r.ok ? r.json() : []),
                    fetch(`${SERVICE2_URL}/api/messages/history`).then(r => r.ok ? r.json() : [])
                ]);

                const allMessages = [];
                if (history1.status === 'fulfilled') {
                    allMessages.push(...(history1.value || []).map(m => ({...m, _source: 'service1'})));
                }
                if (history2.status === 'fulfilled') {
                    allMessages.push(...(history2.value || []).map(m => ({...m, _source: 'service2'})));
                }

                // Sort by timestamp, get last 10
                allMessages.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                const recentMessages = allMessages.slice(0, 10);

                diagram.innerHTML = '';
                if (recentMessages.length === 0) {
                    diagram.innerHTML = '<p style="text-align: center; color: #999;">Aucune communication r√©cente</p>';
                    return;
                }

                recentMessages.forEach(msg => {
                    const isRemote = msg.originService != null && msg.originService !== '';
                    const fromService = msg._source || 'unknown';
                    const toService = isRemote ? (msg.receiverId?.includes('service2') ? 'service2' : 'service1') : fromService;
                    
                    const line = document.createElement('div');
                    line.className = `comm-line ${isRemote ? 'remote' : ''}`;
                    line.innerHTML = `
                        <strong>${fromService}</strong>
                        <span class="comm-arrow">${isRemote ? '‚Üí‚Üí' : '‚Üí'}</span>
                        <strong>${toService}</strong>
                        <span style="margin-left: 20px; color: #666;">
                            ${msg.futureResponse ? 'üî¥ ASK' : 'üîµ TELL'} 
                            ${msg.senderId || 'N/A'} ‚Üí ${msg.receiverId || 'N/A'}
                        </span>
                        <span style="margin-left: 20px; font-size: 11px; color: #999;">
                            ${msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : ''}
                        </span>
                    `;
                    diagram.appendChild(line);
                });
            } catch (error) {
                diagram.innerHTML = '<p style="text-align: center; color: #e74c3c;">Erreur: ' + error.message + '</p>';
            }
        }

        // Envoie un message
        async function sendMessage() {
            const messageType = document.getElementById('messageType').value;
            const senderId = document.getElementById('senderId').value;
            const receiverId = document.getElementById('receiverId').value;
            const content = document.getElementById('messageContent').value;

            if (!senderId || !receiverId || !content) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            const isRemote = receiverId.includes(':');
            let targetService = CURRENT_SERVICE_URL;
            if (isRemote) {
                if (receiverId.startsWith('service1:')) {
                    targetService = SERVICE1_URL;
                } else if (receiverId.startsWith('service2:')) {
                    targetService = SERVICE2_URL;
                } else {
                    const serviceName = receiverId.split(':')[0];
                    targetService = serviceName === 'service1' ? SERVICE1_URL : SERVICE2_URL;
                }
            }

            const endpoint = messageType === 'ask' ? '/api/messages/ask' : '/api/messages/tell';
            const messageBody = {
                senderId: senderId,
                receiverId: receiverId,
                content: content
            };

            try {
                const response = await fetch(`${targetService}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(messageBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.text();
                alert(`Message envoy√©!\n${result}`);
                document.getElementById('messageContent').value = '';
                
                // Refresh all views
                refreshHistory();
                refreshStats();
                refreshLogs();
                refreshCommFlow();
            } catch (error) {
                console.error('Erreur d√©taill√©e:', error);
                alert('Erreur: ' + error.message);
            }
        }

        // Affiche l'inbox d'un service
        async function viewInbox(service) {
            const agentId = service === 'service1' 
                ? document.getElementById('inboxAgent1').value
                : document.getElementById('inboxAgent2').value;

            if (!agentId) {
                const listId = service === 'service1' ? 'inbox1List' : 'inbox2List';
                document.getElementById(listId).innerHTML = '<p style="text-align: center; color: #999;">Veuillez entrer un Agent ID</p>';
                return;
            }

            const serviceUrl = service === 'service1' ? SERVICE1_URL : SERVICE2_URL;
            const listId = service === 'service1' ? 'inbox1List' : 'inbox2List';
            const list = document.getElementById(listId);

            let messages = [];
            try {
                const encodedAgentId = encodeURIComponent(agentId);
                const response = await fetch(`${serviceUrl}/api/messages/inbox/${encodedAgentId}`);
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Erreur inconnue');
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json().catch(() => []);
                messages = Array.isArray(data) ? data : [];
                list.innerHTML = '';

                if (!messages || messages.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #999;">Aucun message</p>';
                    return;
                }

                messages.forEach(msg => {
                    const item = document.createElement('div');
                    item.className = `message-item ${msg.futureResponse ? 'ask' : 'tell'}`;
                    item.innerHTML = `
                        <div class="message-header">
                            ${msg.futureResponse ? 'üî¥ ASK' : 'üîµ TELL'} 
                            de ${msg.senderId || 'N/A'} ‚Üí ${msg.receiverId || 'N/A'}
                        </div>
                        <div class="message-content">${msg.content || ''}</div>
                        <div class="message-meta">
                            ${msg.timestamp ? new Date(msg.timestamp).toLocaleString() : 'Date inconnue'}
                            ${msg.futureResponse ? '<br>‚è≥ En attente de r√©ponse' : ''}
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Erreur inbox:', error);
                list.innerHTML = `<p style="text-align: center; color: #e74c3c;">Erreur: ${error.message}</p>`;
            }
        }

        // Affiche l'historique (combine service1 + service2)
        async function refreshHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '<p style="text-align: center; color: #666;">Chargement...</p>';

            const endpoints = [
                { url: `${SERVICE1_URL}/api/messages/history`, label: 'service1' },
                { url: `${SERVICE2_URL}/api/messages/history`, label: 'service2' }
            ];

            try {
                const results = await Promise.allSettled(
                    endpoints.map(e => fetch(e.url).then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json().then(data => ({ data, label: e.label }));
                    }))
                );

                const messages = [];
                results.forEach(res => {
                    if (res.status === 'fulfilled') {
                        (res.value.data || []).forEach(m => {
                            messages.push({ ...m, _service: res.value.label });
                        });
                    }
                });

                // Update service message counts
                const service1Count = messages.filter(m => m._service === 'service1').length;
                const service2Count = messages.filter(m => m._service === 'service2').length;
                document.getElementById('service1MessageCount').textContent = service1Count;
                document.getElementById('service2MessageCount').textContent = service2Count;

                list.innerHTML = '';
                if (messages.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #999;">Aucun message dans l\'historique</p>';
                    return;
                }

                messages.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                messages.forEach(msg => {
                    const isRemote = msg.originService != null && msg.originService !== '';
                    const item = document.createElement('div');
                    item.className = `message-item ${msg.futureResponse ? 'ask' : 'tell'} ${isRemote ? 'remote' : ''}`;
                    item.innerHTML = `
                        <div class="message-header">
                            ${msg.futureResponse ? 'üî¥ ASK' : 'üîµ TELL'} 
                            ${isRemote ? 'üåê REMOTE (' + (msg.originService || 'unknown') + ')' : 'üè† LOCAL'}
                            ${msg.senderId || 'N/A'} ‚Üí ${msg.receiverId || 'N/A'}
                            <span style="float:right;font-size:12px;color:#555;">${msg._service || ''}</span>
                        </div>
                        <div class="message-content">${msg.content || ''}</div>
                        <div class="message-meta">
                            ${msg.timestamp ? new Date(msg.timestamp).toLocaleString() : 'Date inconnue'}
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Erreur history:', error);
                list.innerHTML = `<p style="text-align: center; color: #e74c3c;">Erreur: ${error.message}</p>`;
            }
        }

        // Affiche les dead letters
        async function refreshDeadLetters() {
            try {
                const response = await fetch(`${CURRENT_SERVICE_URL}/api/messages/deadletters`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const messages = await response.json();

                const list = document.getElementById('deadLettersList');
                list.innerHTML = '';

                if (!messages || messages.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #999;">Aucun dead letter</p>';
                    return;
                }

                messages.forEach(msg => {
                    const item = document.createElement('div');
                    item.className = 'message-item';
                    item.style.borderLeftColor = '#e74c3c';
                    item.innerHTML = `
                        <div class="message-header">
                            üíÄ DEAD LETTER: ${msg.senderId || 'N/A'} ‚Üí ${msg.receiverId || 'N/A'}
                        </div>
                        <div class="message-content">${msg.content || ''}</div>
                        <div class="message-meta">
                            ${msg.timestamp ? new Date(msg.timestamp).toLocaleString() : 'Date inconnue'}
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Erreur:', error);
                const list = document.getElementById('deadLettersList');
                list.innerHTML = `<p style="text-align: center; color: #e74c3c;">Erreur: ${error.message}</p>`;
            }
        }

        // Rafra√Æchit les statistiques
        async function refreshStats() {
            try {
                const [historyRes, deadLettersRes] = await Promise.all([
                    fetch(`${CURRENT_SERVICE_URL}/api/messages/history`),
                    fetch(`${CURRENT_SERVICE_URL}/api/messages/deadletters`)
                ]);

                if (!historyRes.ok || !deadLettersRes.ok) {
                    throw new Error('Erreur lors de la r√©cup√©ration des stats');
                }

                const history = await historyRes.json();
                const deadLetters = await deadLettersRes.json();

                const remoteCount = (history || []).filter(m => m.originService != null && m.originService !== '').length;
                const pendingAsks = (history || []).filter(m => m.futureResponse && !m.futureResponse.done).length;

                document.getElementById('totalMessages').textContent = (history || []).length;
                document.getElementById('remoteMessages').textContent = remoteCount;
                document.getElementById('deadLetters').textContent = (deadLetters || []).length;
                document.getElementById('pendingAsks').textContent = pendingAsks;
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // V√©rifie le statut des services
        async function checkServicesStatus() {
            // Service 1
            const controller1 = new AbortController();
            const timeout1 = setTimeout(() => controller1.abort(), 2000);
            try {
                const res = await fetch(`${SERVICE1_URL}/api/messages/stats`, { 
                    method: 'GET', 
                    signal: controller1.signal 
                });
                clearTimeout(timeout1);
                if (res.ok) {
                    document.getElementById('service1Status').textContent = 'üü¢ Online';
                    document.getElementById('service1Status').className = 'status-badge status-alive';
                } else {
                    throw new Error('Service non disponible');
                }
            } catch {
                clearTimeout(timeout1);
                document.getElementById('service1Status').textContent = 'üî¥ Offline';
                document.getElementById('service1Status').className = 'status-badge status-dead';
            }

            // Service 2
            const controller2 = new AbortController();
            const timeout2 = setTimeout(() => controller2.abort(), 2000);
            try {
                const res = await fetch(`${SERVICE2_URL}/api/messages/stats`, { 
                    method: 'GET', 
                    signal: controller2.signal 
                });
                clearTimeout(timeout2);
                if (res.ok) {
                    document.getElementById('service2Status').textContent = 'üü¢ Online';
                    document.getElementById('service2Status').className = 'status-badge status-alive';
                } else {
                    throw new Error('Service non disponible');
                }
            } catch {
                clearTimeout(timeout2);
                document.getElementById('service2Status').textContent = 'üî¥ Offline';
                document.getElementById('service2Status').className = 'status-badge status-dead';
            }
        }

        function clearForm() {
            document.getElementById('senderId').value = 'agentA';
            document.getElementById('receiverId').value = '';
            document.getElementById('messageContent').value = '';
        }

        function clearHistory() {
            if (confirm('Voulez-vous vraiment effacer l\'historique ?')) {
                document.getElementById('historyList').innerHTML = '';
            }
        }

        function clearLogs() {
            if (confirm('Voulez-vous vraiment effacer les logs ?')) {
                document.getElementById('service1Logs').innerHTML = '<div class="log-entry info">Logs effac√©s</div>';
                document.getElementById('service2Logs').innerHTML = '<div class="log-entry info">Logs effac√©s</div>';
            }
        }

        // Auto-refresh
        setInterval(() => {
            refreshStats();
            checkServicesStatus();
            refreshLogs();
            refreshCommFlow();
        }, 5000);

        // Chargement initial
        setTimeout(() => {
            refreshHistory();
            refreshStats();
            checkServicesStatus();
            refreshLogs();
            refreshCommFlow();
            if (document.getElementById('inboxAgent1').value) {
                viewInbox('service1');
            }
            if (document.getElementById('inboxAgent2').value) {
                viewInbox('service2');
            }
        }, 500);
    </script>
</body>
</html>