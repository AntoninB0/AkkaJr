<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microservices Communication Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .services-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .service-panel {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 15px;
            border-radius: 5px;
        }

        .service-panel.service1 {
            border-left-color: #3498db;
        }

        .service-panel.service2 {
            border-left-color: #e74c3c;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-top: 10px;
        }

        button:hover {
            background: #5568d3;
        }

        .btn-primary { background: #3498db; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #2ecc71; }
        .btn-success:hover { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }

        .message-list {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .message-item {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #ddd;
            background: #f8f9fa;
            border-radius: 3px;
        }

        .message-item.tell {
            border-left-color: #3498db;
        }

        .message-item.ask {
            border-left-color: #e74c3c;
        }

        .message-item.remote {
            background: #fff3cd;
            border-left-color: #f39c12;
        }

        .message-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .message-content {
            color: #666;
            font-size: 14px;
        }

        .message-meta {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 5px 5px 0;
        }

        .status-alive {
            background: #2ecc71;
            color: white;
        }

        .status-dead {
            background: #e74c3c;
            color: white;
        }

        .communication-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        .service-box {
            flex: 1;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .arrow {
            font-size: 2em;
            color: #667eea;
            margin: 0 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê Microservices Communication Dashboard</h1>

        <!-- Service Info -->
        <div class="panel">
            <h2>Service Actuel: <span id="currentServiceName"></span></h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalMessages">0</div>
                    <div class="stat-label">Messages Totaux</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="remoteMessages">0</div>
                    <div class="stat-label">Messages Remote</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="deadLetters">0</div>
                    <div class="stat-label">Dead Letters</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingAsks">0</div>
                    <div class="stat-label">ASK en Attente</div>
                </div>
            </div>
        </div>

        <!-- Communication Flow -->
        <div class="panel">
            <h2>Communication Inter-Microservices</h2>
            <div class="communication-flow">
                <div class="service-box">
                    <h3>Service 1 (Port 8080)</h3>
                    <div id="service1Status" class="status-badge status-alive">üü¢ Online</div>
                </div>
                <div class="arrow">‚áÑ</div>
                <div class="service-box">
                    <h3>Service 2 (Port 8081)</h3>
                    <div id="service2Status" class="status-badge status-alive">üü¢ Online</div>
                </div>
            </div>
        </div>

        <!-- Send Message Panel -->
        <div class="panel">
            <h2>üì§ Envoyer un Message</h2>
            <div class="form-group">
                <label>Type de Message</label>
                <select id="messageType">
                    <option value="tell">TELL (Asynchrone)</option>
                    <option value="ask">ASK (Synchrone)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Exp√©diteur (Sender ID)</label>
                <input type="text" id="senderId" placeholder="Ex: agentA" value="agentA">
            </div>
            <div class="form-group">
                <label>Destinataire (Receiver ID)</label>
                <input type="text" id="receiverId" placeholder="Ex: service2:agentB ou agentB">
                <small style="color: #666;">Format: "service2:agentB" pour remote, "agentB" pour local</small>
            </div>
            <div class="form-group">
                <label>Contenu du Message</label>
                <input type="text" id="messageContent" placeholder="Votre message ici...">
            </div>
            <button onclick="sendMessage()" class="btn-primary">üì§ Envoyer Message</button>
            <button onclick="clearForm()" class="btn-danger">üóëÔ∏è Effacer</button>
        </div>

        <!-- Messages History -->
        <div class="panel">
            <h2>üìú Historique des Messages</h2>
            <button onclick="refreshHistory()" class="btn-success">üîÑ Rafra√Æchir</button>
            <button onclick="clearHistory()" class="btn-danger">üóëÔ∏è Effacer</button>
            <div id="historyList" class="message-list"></div>
        </div>

        <!-- Inbox Panel -->
        <div class="services-grid">
            <div class="service-panel service1">
                <h3>üì• Inbox - Service 1</h3>
                <div class="form-group">
                    <label>Agent ID</label>
                    <input type="text" id="inboxAgent1" placeholder="Ex: agentA" value="agentA">
                    <button onclick="viewInbox('service1')" class="btn-primary">Voir Inbox</button>
                </div>
                <div id="inbox1List" class="message-list"></div>
            </div>

            <div class="service-panel service2">
                <h3>üì• Inbox - Service 2</h3>
                <div class="form-group">
                    <label>Agent ID</label>
                    <input type="text" id="inboxAgent2" placeholder="Ex: agentB" value="agentB">
                    <button onclick="viewInbox('service2')" class="btn-primary">Voir Inbox</button>
                </div>
                <div id="inbox2List" class="message-list"></div>
            </div>
        </div>

        <!-- Dead Letters -->
        <div class="panel">
            <h2>üíÄ Dead Letters (Messages Bloqu√©s)</h2>
            <button onclick="refreshDeadLetters()" class="btn-success">üîÑ Rafra√Æchir</button>
            <div id="deadLettersList" class="message-list"></div>
        </div>
    </div>

    <script>
        const SERVICE1_URL = 'http://localhost:8080';
        const SERVICE2_URL = 'http://localhost:8081';
        const CURRENT_SERVICE = '{{serviceName}}' || 'service1';

        // Affiche le nom du service actuel
        document.getElementById('currentServiceName').textContent = CURRENT_SERVICE;

        // Envoie un message
        async function sendMessage() {
            const messageType = document.getElementById('messageType').value;
            const senderId = document.getElementById('senderId').value;
            const receiverId = document.getElementById('receiverId').value;
            const content = document.getElementById('messageContent').value;

            if (!senderId || !receiverId || !content) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            const isRemote = receiverId.includes(':');
            const targetService = isRemote ? 
                (receiverId.startsWith('service1:') ? SERVICE1_URL : SERVICE2_URL) :
                SERVICE1_URL; // Par d√©faut, envoie depuis service1

            const endpoint = messageType === 'ask' ? '/api/messages/ask' : '/api/messages/tell';
            const messageBody = {
                senderId: senderId,
                receiverId: receiverId,
                content: content
            };

            try {
                const response = await fetch(`${targetService}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(messageBody)
                });

                const result = await response.text();
                alert(`Message envoy√©!\n${result}`);
                document.getElementById('messageContent').value = '';
                refreshHistory();
                refreshStats();
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        // Affiche l'inbox d'un service
        async function viewInbox(service) {
            const agentId = service === 'service1' 
                ? document.getElementById('inboxAgent1').value
                : document.getElementById('inboxAgent2').value;

            if (!agentId) {
                alert('Veuillez entrer un Agent ID');
                return;
            }

            const serviceUrl = service === 'service1' ? SERVICE1_URL : SERVICE2_URL;
            const listId = service === 'service1' ? 'inbox1List' : 'inbox2List';

            try {
                const response = await fetch(`${serviceUrl}/api/messages/inbox/${agentId}`);
                const messages = await response.json();

                const list = document.getElementById(listId);
                list.innerHTML = '';

                if (messages.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #999;">Aucun message</p>';
                    return;
                }

                messages.forEach(msg => {
                    const item = document.createElement('div');
                    item.className = `message-item ${msg.futureResponse ? 'ask' : 'tell'}`;
                    item.innerHTML = `
                        <div class="message-header">
                            ${msg.futureResponse ? 'üî¥ ASK' : 'üîµ TELL'} 
                            de ${msg.senderId} ‚Üí ${msg.receiverId}
                        </div>
                        <div class="message-content">${msg.content}</div>
                        <div class="message-meta">
                            ${new Date(msg.timestamp).toLocaleString()}
                            ${msg.futureResponse ? '<br>‚è≥ En attente de r√©ponse' : ''}
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // Affiche l'historique
        async function refreshHistory() {
            try {
                const response = await fetch(`${SERVICE1_URL}/api/messages/history`);
                const messages = await response.json();

                const list = document.getElementById('historyList');
                list.innerHTML = '';

                if (messages.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #999;">Aucun message dans l\'historique</p>';
                    return;
                }

                messages.forEach(msg => {
                    const isRemote = msg.originService != null && msg.originService !== '';
                    const item = document.createElement('div');
                    item.className = `message-item ${msg.futureResponse ? 'ask' : 'tell'} ${isRemote ? 'remote' : ''}`;
                    item.innerHTML = `
                        <div class="message-header">
                            ${msg.futureResponse ? 'üî¥ ASK' : 'üîµ TELL'} 
                            ${isRemote ? 'üåê REMOTE (' + msg.originService + ')' : 'üè† LOCAL'}
                            ${msg.senderId} ‚Üí ${msg.receiverId}
                        </div>
                        <div class="message-content">${msg.content}</div>
                        <div class="message-meta">
                            ${new Date(msg.timestamp || 0).toLocaleString()}
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // Affiche les dead letters
        async function refreshDeadLetters() {
            try {
                const response = await fetch(`${SERVICE1_URL}/api/messages/deadletters`);
                const messages = await response.json();

                const list = document.getElementById('deadLettersList');
                list.innerHTML = '';

                if (messages.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #999;">Aucun dead letter</p>';
                    return;
                }

                messages.forEach(msg => {
                    const item = document.createElement('div');
                    item.className = 'message-item';
                    item.style.borderLeftColor = '#e74c3c';
                    item.innerHTML = `
                        <div class="message-header">
                            üíÄ DEAD LETTER: ${msg.senderId} ‚Üí ${msg.receiverId}
                        </div>
                        <div class="message-content">${msg.content}</div>
                        <div class="message-meta">
                            ${new Date(msg.timestamp || 0).toLocaleString()}
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // Rafra√Æchit les statistiques
        async function refreshStats() {
            try {
                const [historyRes, deadLettersRes] = await Promise.all([
                    fetch(`${SERVICE1_URL}/api/messages/history`),
                    fetch(`${SERVICE1_URL}/api/messages/deadletters`)
                ]);

                const history = await historyRes.json();
                const deadLetters = await deadLettersRes.json();

                const remoteCount = history.filter(m => m.originService != null && m.originService !== '').length;
                const pendingAsks = history.filter(m => m.futureResponse && !m.futureResponse.done).length;

                document.getElementById('totalMessages').textContent = history.length;
                document.getElementById('remoteMessages').textContent = remoteCount;
                document.getElementById('deadLetters').textContent = deadLetters.length;
                document.getElementById('pendingAsks').textContent = pendingAsks;
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // V√©rifie le statut des services
        async function checkServicesStatus() {
            try {
                await fetch(`${SERVICE1_URL}/api/messages/history`);
                document.getElementById('service1Status').textContent = 'üü¢ Online';
                document.getElementById('service1Status').className = 'status-badge status-alive';
            } catch {
                document.getElementById('service1Status').textContent = 'üî¥ Offline';
                document.getElementById('service1Status').className = 'status-badge status-dead';
            }

            try {
                await fetch(`${SERVICE2_URL}/api/messages/history`);
                document.getElementById('service2Status').textContent = 'üü¢ Online';
                document.getElementById('service2Status').className = 'status-badge status-alive';
            } catch {
                document.getElementById('service2Status').textContent = 'üî¥ Offline';
                document.getElementById('service2Status').className = 'status-badge status-dead';
            }
        }

        function clearForm() {
            document.getElementById('senderId').value = 'agentA';
            document.getElementById('receiverId').value = '';
            document.getElementById('messageContent').value = '';
        }

        function clearHistory() {
            if (confirm('Voulez-vous vraiment effacer l\'historique ?')) {
                document.getElementById('historyList').innerHTML = '';
            }
        }

        // Auto-refresh
        setInterval(() => {
            refreshStats();
            checkServicesStatus();
        }, 5000);

        // Chargement initial
        refreshHistory();
        refreshStats();
        checkServicesStatus();
        viewInbox('service1');
        viewInbox('service2');
    </script>
</body>
</html>